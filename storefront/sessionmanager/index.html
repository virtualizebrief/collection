<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width">
  <title>Session Manager</title>
  <link rel="icon" type="image/x-icon" href="favicon.ico">
  <link rel="stylesheet" href="settings.css">
  <link href="Content/themes/base/jquery-ui.css" rel="stylesheet" />
  <script src="Scripts/jquery-3.5.1.min.js"></script>
  <script src="Scripts/jquery-ui-1.12.1.min.js"></script>
</head>
<body>
<div class="content-wrapper">
 
  <div class="purple" align="left">
		&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<img src="StoreFront-GreenLine.png"> 
  </div>
   
  <div class="butMenuBar" align="right">
		<form action='#'><input type='submit' value='Service Desk' class='butMenu'/></form><form action='#'><input type='submit' value='Knowledge Base' class='butMenu'/></form>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
  </div>
  
<div class="divider"></div>
 
<div class="white">
  <div class="header-biggest">
	<center>Session Manager</center>
  </div>
  <div class="header-smaller ">
	<center>Providing a place to manage your Citrix sessions. <a href="#">Learn more</a>.</center>
  </div>
</div>
  
<div class="divider"></div>

  <div class="white">
    <center><p><b id="welcome"></b><b>!</b><br></p>
    <div class="content-selection">
        <select id="selectEnvironment">
        </select>
    </div>
	<center>
    <div id="dialog">
        <p id="statusmessage"></p>

    </div>
	</center>
	<!--<br>
    <label for="search-sessions-input">Search any data in the sessions table:</label>
    <input id="search-sessions-input" class="form-control" type="text" />-->
    <table id="sessionsTable" class="content-table">
        <thead>
            <tr>
                <th>
                    <div class="checkbox">
                        <input type="checkbox" id="selectAllsessions">
                        <label for="selectAllsessions"></label>
                    </div>
                </th>
                <!--Add an EM space at the end of each description, which will be replaced with the ascending or descending arrow when selected-->
				<th data-colname="MachineName" data-order="desc">Machine Name&#8195</th>
                <th data-colname="SessionState" data-order="desc">Session State&#8195</th>
                <th data-colname="StartTime" data-order="desc">Start Time&#8195</th>
                <th data-colname="SessionStateChangeTime" data-order="desc">Session State<br />Change Time&#8195</th>
                <th data-colname="ApplicationState" data-order="desc">Application State&#8195</th>
                <th data-colname="ApplicationStateLastChangeTime" data-order="desc">Application State<br />Last Change Time&#8195</th>
                <th data-colname="ApplicationsInUse" data-order="desc">Applications In Use&#8195</th>
                <th data-colname="IdleDuration" data-order="desc">Idle Duration&#8195</th>
                <th data-colname="IdleSince" data-order="desc">Idle Since&#8195</th>
                <!--Hide this element by default and then we make it visible on document load depending on the appSettings-->
                <th data-colname="RestartSupported" data-order="desc" style="display:none">Restart<br />Supported&#8195</th>
                <!--Hide this element by default and then we make it visible on document load depending on the appSettings-->
                <th data-colname="Hidden" data-order="desc" style="display:none">Hidden&#8195</th>
                <th data-colname="MaintenanceMode" data-order="desc">Maintenance<br />Mode&#8195</th>
                <th data-colname="PowerState" data-order="desc">Power<br />State&#8195</th>
                <th data-colname="RegistrationState" data-order="desc">Registration<br />State&#8195</th>
            </tr>
        </thead>
        <!-- Display this <tr> when no record found while search -->
        <tr class='sessionnotfound'>
            <td colspan='4'>No session found</td>
        </tr>
	    <tbody id="sessionsTableBody" class="greyfont">
        </tbody>
    </table>
    <!--Hide this element by default and then we make it visible on document load depending on the appSettings-->
    <div id="InstructionsSection" style="display:none">
    </div>
    <!--Hide this element by default and then we make it visible on document load depending on the appSettings-->
	<a href='index.html'><button class="butOrange"><font size=1>&#8635;</font> Refresh Sessions</button></a>
    <button class="button2" id="logoffSessions" style="display:none">Logoff Sessions</button>
    <!--Hide this element by default and then we make it visible on document load depending on the appSettings-->
    <button class="button2" id="disconnectSessions" style="display:none">Disconnect Sessions</button>
    <!--Hide this element by default and then we make it visible on document load depending on the appSettings-->
    <button class="button2" id="getProcesses" style="display:none"></button>
    <!--Hide this element by default and then we make it visible on document load depending on the appSettings-->
    <button class="button2" id="restartMachinesGracefully" style="display:none"></button>
    <!--Hide this element by default and then we make it visible on document load depending on the appSettings-->
    <button class="button2" id="restartMachinesForcefully" style="display:none"></button>
    <!--Hide this element by default and then we make it visible on document load depending on the appSettings-->
    <button class="butRed" id="hideSessions" style="display:none">Fix Me</button>
    <!--Hide this element by default and then we make it visible on document load depending on the appSettings-->
    <button class="button" id="unhideSessions" style="display:none">Unhide Sessions</button>
    <!--Hide this element by default and then we make it visible on document load depending on the appSettings-->
    <button class="button2" id="terminateProcesses" style="display:none"></button>
    <div id="GetTerminateProcessesSection" style="display:none">
        <br /><br />
        <label for="search-processes-input"></label>
        <p></p>

    </div>
    <script type="text/javascript">
        // Create the global variables
        var sessionsArray = [];
        var processesArray = [];
        var username = "";
        var sitename = "";
        var deliverycontrollers = "";
        var port = "";
        var displayname = "";

        // Predefining default variable settings
        var EnableLogoffSessions = true;
        var EnableDisconnectSessions = false;
        var EnableGetTerminateProcesses = false;
        var EnableGracefulMachineRestart = false;
        var EnableForcedMachineRestart = false;
        var EnableHideStuckSessions = false;
        var EnableInstructions = true;
        var BypassCriteriaChecksForHideSessions = false;
        var EnableUnhideSessions = false;

        function Get24hourTime() {
            var time = new Date();
            var hours = (time.getHours() < 10 ? '0' : '') + time.getHours();
            var minutes = (time.getMinutes() < 10 ? '0' : '') + time.getMinutes();
            var seconds = (time.getSeconds() < 10 ? '0' : '') + time.getSeconds();
            var timestamp = hours + ":" + minutes + ":" + seconds;
            return timestamp;
        }
        var tdCheckboxChecked = 0; // checked checboxes

        // This function uses an fetch with an async await to read the app settings
        // from the Web.config file and set the variables accordingly. We also nest
        // the getLoggedOnUserName, getDisplayName, and getCtxSiteList to take
        // advantage of the lock on the ready event.
        const getAppSettings = async () => {
            const response = await fetch("api/CtxSession/GetAppSettings", {
                method: "GET",
                headers: {
                    Accept: "application/json"
                }
            });
            const result = await response.json();
            for (var i = 0; i < result.length; i++) {
                var thekey = result[i].key;
                if (result[i].value.toLowerCase() === 'true') {
                    eval(thekey + " = " + true + ";");
                } else {
                    eval(thekey + " = " + false + ";");
                };
                //console.info("Setting the value for:" + thekey);
            };
            if (BypassCriteriaChecksForHideSessions || EnableUnhideSessions) {
                EnableHideStuckSessions = true;
            }
            if (EnableUnhideSessions) {
                BypassCriteriaChecksForHideSessions = true;
            }
            console.info("AppSettings:", result);
            // Get the logged on username
            getLoggedOnUserName()
            // Lookup the displayname from Active Directory for the welcome message
            getDisplayName()
            // Load the Site List from an XML file stored under App_Data
            getCtxSiteList()
            // Remove the lock from the ready event
            $.holdReady(false)
        }

        // Put a lock the ready event until the app settings and initial variables are set.
        $.holdReady(true)
        // Call the function to get the app settings.
        getAppSettings();

        // Initialise some tasks on document load
        $(document).ready(function () {
            if (EnableLogoffSessions) {
                // Make the logoffSessions button visible
                document.getElementById("logoffSessions").style.display = "";
                // Disable the logoffSessions button
                $("#logoffSessions").attr("disabled", true);
            };
            if (EnableDisconnectSessions) {
                // Make the disconnectSessions button visible
                document.getElementById("disconnectSessions").style.display = "";
                // Disable the disconnectSession button
                $("#disconnectSessions").attr("disabled", true);
            };
            if (EnableGracefulMachineRestart) {
                // Show the Restart Supported column in the sessionsTable
                $('#sessionsTable td:nth-child(11), #sessionsTable th:nth-child(11)').show();
                // Make the restartMachinesGracefully button visible
                document.getElementById("restartMachinesGracefully").style.display = "";
                // Disable the restartMachinesGracefully button
                $("#restartMachinesGracefully").attr("disabled", true);
            }
            if (EnableForcedMachineRestart) {
                // Show the Restart Supported column in the sessionsTable
                $('#sessionsTable td:nth-child(11), #sessionsTable th:nth-child(11)').show();
                // Make the restartMachinesForcefully button visible
                document.getElementById("restartMachinesForcefully").style.display = "";
                // Disable the restartMachinesForcefully button
                $("#restartMachinesForcefully").attr("disabled", true);
            };
            if (EnableGetTerminateProcesses) {
                // Make the getProcesses button visible
                document.getElementById("getProcesses").style.display = "";
                // Disable the getProcesses button
                $("#getProcesses").attr("disabled", true);
                // Make the terminateProcesses button visible
                document.getElementById("terminateProcesses").style.display = "";
                // Disable the terminateProcess button
                $("#terminateProcesses").attr("disabled", true);
                // Make the GetTerminateProcessesSection section visible
                document.getElementById("GetTerminateProcessesSection").style.display = "";
            };
            if (EnableHideStuckSessions) {
                // Show the Hidden column in the sessionsTable
                $('#sessionsTable td:nth-child(12), #sessionsTable th:nth-child(12)').show();
                // Make the hideSessions button visible
                document.getElementById("hideSessions").style.display = "";
                // Disable the hideSessions button
                $("#hideSessions").attr("disabled", true);
            };
            if (EnableUnhideSessions) {
                // Show the Hidden column in the sessionsTable
                $('#sessionsTable td:nth-child(12), #sessionsTable th:nth-child(12)').show();
                // Make the unhideSessions button visible
                document.getElementById("unhideSessions").style.display = "";
                // Disable the unhideSessions button
                $("#unhideSessions").attr("disabled", true);
            };
            if (EnableInstructions) {
                // Make the InstructionsSection section visible
                document.getElementById("InstructionsSection").style.display = "";
                buildInstructions()
            };
        });

        // Initialize the dialog box
        $("#dialog").dialog({
            modal: true,
            autoOpen: false,
            width: 500,
            height: 320,
            resizable: false,
            draggable: false,
            title: "Processing Request",
            //background scrolling with modal
            allowScrolling: true,
            close: function (event, ui) { $('#dialog').show(); },
            open: function (event, ui) {
                $('.ui-widget-overlay').bind('click', function () {
                    $("#dialog").dialog('close');
                });
            },
            buttons: {
                Ok: function () {
                    $(this).dialog("close");
                }
            }
        });

        ///////////////////////////////////////////////////////////////////////////////
        // Use a MutationObserver to monitor changes to the #statusmessage so
        // we can scroll to the bottom of the dialog to ensure the latest
        // status updates are in view.

        // The node to be monitored
        var dialogtargetNode = $("#statusmessage")[0];

        // Options for the observer (which mutations to observe)
        var dialogconfig = { attributes: true, childList: true };

        // Create an observer instance
        var dialogObserver = new MutationObserver(function (mutations) {
            mutations.forEach(function (mutation) {
                var newNodes = mutation.addedNodes; // DOM NodeList
                if (newNodes !== null) { // If there are new nodes added
                    if ($('#dialog').dialog('isOpen')) {
                        $('#dialog').animate({
                            scrollTop: $(this).scrollTop() + $(this).height()
                        });
                    };
                }
            });
        });

        // Pass in the target node, as well as the observer options
        dialogObserver.observe(dialogtargetNode, dialogconfig);

        ///////////////////////////////////////////////////////////////////////////////

        // This function opens the dialog modal
        function OpenStatusPopup() {
            $('#dialog').dialog('open');
        };

        // Get the Sessions based on Site List Selection
        $("#selectEnvironment").change(function () {
            ProcessSelectEnvironment();
        })

        function ProcessSelectEnvironment() {
            // Set the global variable
            sitename = $("#selectEnvironment option:selected").data('valuea');
            console.info("Site Name:", sitename);
            deliverycontrollers = $("#selectEnvironment option:selected").data('valueb');
            console.info("Delivery Controllers:", deliverycontrollers);
            port = $("#selectEnvironment option:selected").data('valuec');
            console.info("Port:", port);
            //getSessions(sitename, deliverycontrollers, port)
            OpenStatusPopup()
            $("#statusmessage").append("<span>" + "Getting sessions...</br></span>");
            var querystring = "sitename=" + sitename + "&deliverycontrollers=" + deliverycontrollers + "&port=" + port;
            $.ajax({
                method: 'GET',
                url: 'api/CtxSession/GetSessions?' + querystring,
                success: function (response) {
                    sessionsArray = response
                    var message = "";
                    switch (sessionsArray.length) {
                        case 0:
                            message = "There were no sessions found<br>";
                            break;
                        case 1:
                            message = "There was 1 session found<br>";
                            break;
                        default:
                            message = "There were " + sessionsArray.length + " sessions found<br>";
                    }
                    OpenStatusPopup()
                    $("#statusmessage").append("<span>" + message + "</br></span>");
                    buildSessionsTable(sessionsArray)
                    console.info("Sessions:", sessionsArray)
                    if (sessionsArray.length >= 1) {
                        if (EnableLogoffSessions) {
                            // Enable the logoffSessions button
                            $("#logoffSessions").attr("disabled", false);
                            //$("#logoffSessions").removeAttr("disabled");
                        }
                        if (EnableDisconnectSessions) {
                            // Enable the disconnectSession button
                            $("#disconnectSessions").attr("disabled", false);
                        }
                        if (EnableGracefulMachineRestart) {
                            // Enable the restartMachinesGracefully button
                            $("#restartMachinesGracefully").attr("disabled", false);
                        }
                        if (EnableForcedMachineRestart) {
                            // Enable the restartMachinesForcefully button
                            $("#restartMachinesForcefully").attr("disabled", false);
                        };
                        if (EnableGetTerminateProcesses) {
                            // Enable the getProcesses button
                            $("#getProcesses").attr("disabled", false);
                        };
                        if (EnableHideStuckSessions) {
                            // Enable the hideSessions button
                            $("#hideSessions").attr("disabled", false);
                        }
                        if (EnableUnhideSessions) {
                            // Enable the unhideSessions button
                            $("#unhideSessions").attr("disabled", false);
                        }
                    }
                }
            })
        };

        // Create an action to logoff selected sessions
        $('#logoffSessions').click(function () {
            var sessions = [];
            $.each($('input:checkbox[id^="tr-session-checkbox"]:checked'), function (index, value) {
                var data = $(this).parents('tr:eq(0)');
                if ($(data).find('td:eq(1)').text() != '') {
                    sessions.push($(data).find('td:eq(1)').text());
                }
            });
            var message = "";
            if (sessions.length >= 1) {
                logoffSessions(sitename, deliverycontrollers, port, sessions);
                console.info("Selected sessions:", sessions);
            } else {
                message = "No sessions selected<br>";
            }
            if (message != "") {
                OpenStatusPopup()
                $("#statusmessage").append("<span>" + message + "</br></span>");
                console.info(message);
            }
        });

        // Create an action to disconnect selected sessions
        $('#disconnectSessions').click(function () {
            var sessions = [];
            $.each($('input:checkbox[id^="tr-session-checkbox"]:checked'), function (index, value) {
                var data = $(this).parents('tr:eq(0)');
                if ($(data).find('td:eq(1)').text() != '') {
                    sessions.push($(data).find('td:eq(1)').text());
                }
            });
            var message = "";
            if (sessions.length >= 1) {
                disconnectSessions(sitename, deliverycontrollers, port, sessions);
                console.info("Selected sessions:", sessions);
            } else {
                message = "No sessions selected<br>";
            }
            if (message != "") {
                OpenStatusPopup()
                $("#statusmessage").append("<span>" + message + "</br></span>");
                console.info(message);
            }
        });

        // Create an action to gracefully restart selected machines
        $('#restartMachinesGracefully').click(function () {
            var reset = false;
            var sessions = [];
            $.each($('input:checkbox[id^="tr-session-checkbox"]:checked'), function (index, value) {
                var data = $(this).parents('tr:eq(0)');
                if ($(data).find('td:eq(1)').text() != '') {
                    sessions.push($(data).find('td:eq(1)').text());
                }
            });
            var message = "";
            if (sessions.length >= 1) {
                restartMachines(sitename, deliverycontrollers, port, sessions, reset);
                console.info("Selected sessions:", sessions);
            } else {
                message = "No sessions selected<br>";
            }
            if (message != "") {
                OpenStatusPopup()
                $("#statusmessage").append("<span>" + message + "</br></span>");
                console.info(message);
            }
        });

        // Create an action to forcefully restart selected machines
        $('#restartMachinesForcefully').click(function () {
            var reset = true;
            var sessions = [];
            $.each($('input:checkbox[id^="tr-session-checkbox"]:checked'), function (index, value) {
                var data = $(this).parents('tr:eq(0)');
                if ($(data).find('td:eq(1)').text() != '') {
                    sessions.push($(data).find('td:eq(1)').text());
                }
            });
            var message = "";
            if (sessions.length >= 1) {
                restartMachines(sitename, deliverycontrollers, port, sessions, reset);
                console.info("Selected sessions:", sessions);
            } else {
                message = "No sessions selected<br>";
            }
            if (message != "") {
                OpenStatusPopup()
                $("#statusmessage").append("<span>" + message + "</br></span>");
                console.info(message);
            }
        });

        // Create an action to hide selected sessions
        $('#hideSessions').click(function () {
            var hide = true;
            var sessions = [];
            $.each($('input:checkbox[id^="tr-session-checkbox"]:checked'), function (index, value) {
                var data = $(this).parents('tr:eq(0)');
                if ($(data).find('td:eq(1)').text() != '') {
                    sessions.push($(data).find('td:eq(1)').text());
                }
            });
			
			// Add Disconnect to Hide Button or Fix Me
            var message = "";
            if (sessions.length >= 1) {
                disconnectSessions(sitename, deliverycontrollers, port, sessions);
                console.info("Selected sessions:", sessions);
            } else {
                message = "No sessions selected<br>";
            }
            if (message != "") {
                OpenStatusPopup()
                $("#statusmessage").append("<span>" + message + "</br></span>");
                console.info(message);
            }
			
			// Add Logoff to Hide Button or Fix Me
            var message = "";
            if (sessions.length >= 1) {
                logoffSessions(sitename, deliverycontrollers, port, sessions);
                console.info("Selected sessions:", sessions);
            } else {
                message = "";
            }
            if (message != "") {
                OpenStatusPopup()
                $("#statusmessage").append("<span>" + message + "</br></span>");
                console.info(message);
            }
			
			// Add Hide to Hide Button or Fix Me
            var message = "";
            if (sessions.length >= 1) {
                hideSessions(sitename, deliverycontrollers, port, sessions, hide);
                console.info("Selected sessions:", sessions);
            } else {
                message = "";
            }
            if (message != "") {
                OpenStatusPopup()
                $("#statusmessage").append("<span>" + message + "</br></span>");
                console.info(message);
            }
        });

        // Create an action to unhide selected sessions
        $('#unhideSessions').click(function () {
            var hide = false;
            var sessions = [];
            $.each($('input:checkbox[id^="tr-session-checkbox"]:checked'), function (index, value) {
                var data = $(this).parents('tr:eq(0)');
                if ($(data).find('td:eq(1)').text() != '') {
                    sessions.push($(data).find('td:eq(1)').text());
                }
            });
            var message = "";
            if (sessions.length >= 1) {
                hideSessions(sitename, deliverycontrollers, port, sessions, hide);
                console.info("Selected sessions:", sessions);
            } else {
                message = "No sessions selected<br>";
            }
            if (message != "") {
                OpenStatusPopup()
                $("#statusmessage").append("<span>" + message + "</br></span>");
                console.info(message);
            }
        });

        // Create an action to get the user processes from the selected session
        $('#getProcesses').click(function () {
            var sessions = [];
            $.each($('input:checkbox[id^="tr-session-checkbox"]:checked'), function (index, value) {
                var sessiondata = $(this).parents('tr:eq(0)');
                if ($(sessiondata).find('td:eq(1)').text() != '') {
                    sessions.push($(sessiondata).find('td:eq(1)').text());
                }
            });
            var message = "";
            if (sessions.length >= 1) {
                // Enable the terminateProcesses button
                $("#terminateProcesses").attr("disabled", false);
                if (sessions.length == 1) {
                    getProcesses(sessions);
                    console.info("Selected host:", sessions);
                } else {
                    message = "More than 1 host was selected";
                }
            } else {
                message = "A host was not selected";
            }
            if (message != "") {
                OpenStatusPopup()
                $("#statusmessage").append("<span>" + message + "</br></span>");
                console.info(message);
            }
        });

        // Create an action to terminate the user processes
        $('#terminateProcesses').click(function () {
            var remotehost = [];
            $.each($('input:checkbox[id^="tr-session-checkbox"]:checked'), function (index, value) {
                var sessiondata = $(this).parents('tr:eq(0)');
                if ($(sessiondata).find('td:eq(1)').text() != '') {
                    remotehost.push($(sessiondata).find('td:eq(1)').text());
                }
            });
            var message = "";
            if (remotehost.length == 1) {
                remotehost.toString();
                var pids = [];
                $.each($('input:checkbox[id^="tr-process-checkbox"]:checked'), function (index, value) {
                    var processdata = $(this).parents('tr:eq(0)');
                    if ($(processdata).find('td:eq(2)').text() != '') {
                        pids.push($(processdata).find('td:eq(2)').text());
                    }
                });
                if (pids.length >= 1) {
                    terminateProcesses(remotehost, pids);
                    console.info("Selected PIDs:", pids);
                } else {
                    message = "No processes were selected";
                }
            } else if (remotehost.length == 0) {
                message = "No hosts were selected";
            } else {
                message = "More than 1 host was selected";
            }
            if (message != "") {
                OpenStatusPopup()
                $("#statusmessage").append("<span>" + message + "</br></span>");
                console.info(message);
            }
        });

        ///////////////////////////////////////////////////////////////////////////////
        // Use a MutationObserver to monitor changes to the #sessionsTableBody so
        // we can create an event monitor to toggle the main checkbox state.

        // The node to be monitored
        var sessionsTabletargetNode = document.getElementById('sessionsTableBody');

        // Options for the observer (which mutations to observe)
        var sessionsTableconfig = { attributes: true, childList: true };

        // Callback function to execute when mutations are observed
        var sessionsTablecallback = function (mutationsList) {
            for (var mutation of mutationsList) {
                if (mutation.type == 'childList') {
                    //console.log('A child node has been added or removed.');
                    // Toggle main checkbox state to checked when all non disabled checkboxes inside tbody tag are checked
                    $('#sessionsTable').find('tbody input:checkbox').on('click', function (e) {
                        tdCheckboxChecked = $('#sessionsTable').find('tbody input:checkbox:checked').not(":disabled").length; // Get count of checkboxes that is checked
                        // If all checkboxes are checked, set property of main checkbox to "true", else set to "false"
                        $('#selectAllsessions').prop('checked', (tdCheckboxChecked === $('#sessionsTable').find('tbody input:checkbox').not(":disabled").length));
                    });
                }
                else if (mutation.type == 'attributes') {
                    //console.log('The ' + mutation.attributeName + ' attribute was modified.');
                }
            }
        };

        // Create an observer instance linked to the callback function
        var sessionsTableobserver = new MutationObserver(sessionsTablecallback);

        // Start observing the target node for configured mutations
        sessionsTableobserver.observe(sessionsTabletargetNode, sessionsTableconfig);

        ///////////////////////////////////////////////////////////////////////////////

        // Create an event when the Select All checkbox in the column header is selected
        // Select or deselect all enabled checkboxes depending on main checkbox change
        $('#selectAllsessions').on('click', function (e) {
            //$(this).closest('table').find('td input:checkbox').prop('checked', this.checked);
            $(this).closest('table').find('td input:checkbox').not(":disabled").prop('checked', this.checked);
        });

        // Reorders the sessions table when selecting column headers for ascending and descending
        $('#sessionsTable th').on('click', function () {
            if ($(this).parents('table').attr('id') == "sessionsTable") {
                var column = $(this).data('colname');
                var order = $(this).data('order');
                var text = $(this).html();
                // Skip the checkbox column
                if (text.toLowerCase().indexOf("checkbox") == -1) {
                    // Replace the em space with the up or down arrow
                    text = text.substring(0, text.length - 1);
                    if (order == 'desc') {
                        sessionsArray = sessionsArray.sort((a, b) => a[column] > b[column] ? 1 : -1)
                        $(this).data("order", "asc");
                        text += '&#9660'
                    } else {
                        sessionsArray = sessionsArray.sort((a, b) => a[column] < b[column] ? 1 : -1)
                        $(this).data("order", "desc");
                        text += '&#9650'
                    }
                    $(this).html(text)
                    buildSessionsTable(sessionsArray)
                }
            }
        });

        // Search all columns in the Sessions table
        $('#search-sessions-input').keyup(function () {
            // Search Text
            var search = $(this).val();
            // Hide all table tbody rows
            $('table tbody tr.session-row').hide();
            $('table tbody tr.sessionnotfound').hide();
            // Count total search result
            var len = $('table tbody tr.session-row:not(.sessionnotfound) td:contains("' + search + '")').length;
            if (len > 0) {
                // Searching text in columns and show match row
                $('table tbody tr.session-row:not(.sessionnotfound) td:contains("' + search + '")').each(function () {
                    $(this).closest('tr').show();
                });
            } else {
                $('.sessionnotfound').show();
            }
        });

        ///////////////////////////////////////////////////////////////////////////////
        // Use a MutationObserver to monitor changes to the #processesTableBody so
        // we can create an event monitor to toggle the main checkbox state.

        // The node to be monitored
        var processesTabletargetNode = document.getElementById('processesTableBody');

        // Options for the observer (which mutations to observe)
        var processesTableconfig = { attributes: true, childList: true };

        // Callback function to execute when mutations are observed
        var processesTablecallback = function (mutationsList) {
            for (var mutation of mutationsList) {
                if (mutation.type == 'childList') {
                    //console.log('A child node has been added or removed.');
                    // Toggle main checkbox state to checked when all checkboxes inside tbody tag are checked
                    $('#processesTable').find('tbody input:checkbox').on('click', function (e) {
                        tdCheckboxChecked = $('#processesTable').find('tbody input:checkbox:checked').length; // Get count of checkboxes that is checked
                        // If all checkboxes are checked, set property of main checkbox to "true", else set to "false"
                        $('#selectAllprocesses').prop('checked', (tdCheckboxChecked === $('#processesTable').find('tbody input:checkbox').length));
                    });
                }
                else if (mutation.type == 'attributes') {
                    //console.log('The ' + mutation.attributeName + ' attribute was modified.');
                }
            }
        };

        // Create an observer instance linked to the callback function
        var processesTableobserver = new MutationObserver(processesTablecallback);

        // Start observing the target node for configured mutations
        processesTableobserver.observe(processesTabletargetNode, processesTableconfig);

        ///////////////////////////////////////////////////////////////////////////////

        // Create an event when the Select All checkbox in the column header is selected
        // Select or deselect all checkboxes depending on main checkbox change
        $('#selectAllprocesses').click(function (e) {
            $(this).closest('table').find('td input:checkbox').prop('checked', this.checked);
        });

        // Reorders the processes table when selecting column headers for ascending and descending
        $('#processesTable th').on('click', function () {
            if ($(this).parents('table').attr('id') == "processesTable") {
                var column = $(this).data('colname');
                var order = $(this).data('order');
                var text = $(this).html();
                // Skip the checkbox column
                if (text.toLowerCase().indexOf("checkbox") == -1) {
                    // Replace the em space with the up or down arrow
                    text = text.substring(0, text.length - 1);
                    if (order == 'desc') {
                        processesArray = processesArray.sort((a, b) => a[column] > b[column] ? 1 : -1)
                        $(this).data("order", "asc");
                        text += '&#9660'
                    } else {
                        processesArray = processesArray.sort((a, b) => a[column] < b[column] ? 1 : -1)
                        $(this).data("order", "desc");
                        text += '&#9650'
                    }
                    $(this).html(text)
                    buildProcessesTable(processesArray)
                }
            }
        });

        // Search all columns in the Processes table
        $('#search-processes-input').keyup(function () {
            // Search Text
            var search = $(this).val();
            // Hide all table tbody rows
            $('table tbody tr.process-row').hide();
            $('table tbody tr.processnotfound').hide();
            // Count total search result
            var len = $('table tbody tr.process-row td:contains("' + search + '")').length;
            if (len > 0) {
                // Searching text in columns and show match row
                $('table tbody tr.process-row td:contains("' + search + '")').each(function () {
                    $(this).closest('tr').show();
                });
            } else {
                $('.processnotfound').show();
            }
        });

        // Case-insensitive searching
        $.expr[":"].contains = $.expr.createPseudo(function (arg) {
            return function (elem) {
                return $(elem).text().toUpperCase().indexOf(arg.toUpperCase()) >= 0;
            };
        });

        // This function will build the table of sessions
        function buildSessionsTable(data) {
            var table = document.getElementById('sessionsTableBody')
            table.innerHTML = ''

            for (var i = 0; i < data.length; i++) {
                // Remove the domain name from the display of the MachineName
                var MachineName = data[i].MachineName.split('\\')[1];
                // Join the ApplicationsInUse array using line breaks instead of commas
                var ApplicationsInUse = "";
                if (data[i].ApplicationsInUse.length >= 1) {
                    ApplicationsInUse = data[i].ApplicationsInUse.join("<br />");
                }
                // Changing all time stamp data to add a line break between the date and time to reduce column width
                var StartTime = data[i].StartTime.replace(' ', "<br />")
                var SessionStateChangeTime = data[i].SessionStateChangeTime.replace(' ', "<br />")
                var ApplicationStateLastChangeTime = data[i].ApplicationStateLastChangeTime.replace(' ', "<br />")
                var IdleSince = data[i].IdleSince.replace(' ', "<br />")
                if (data[i].Include == true) {
                    var row = `<tr class="session-row">
                                                                                                    <td>
                                                                                                        <div class="checkbox">
                                                                                                            <input type="checkbox" id="tr-session-checkbox${i}">
                                                                                                            <label for="tr-session-checkbox${i}"></label>
                                                                                                        </div>
                                                                                                    </td>
                                                                                                    <td nowrap="nowrap">${MachineName}</td>
                                                                                                    <td>${data[i].SessionState}</td>
                                                                                                    <td>${StartTime}</td>
                                                                                                    <td>${SessionStateChangeTime}</td>
                                                                                                    <td>${data[i].ApplicationState}</td>
                                                                                                    <td>${ApplicationStateLastChangeTime}</td>
                                                                                                    <td nowrap="nowrap">${ApplicationsInUse}</td>
                                                                                                    <td>${data[i].IdleDuration}</td>
                                                                                                    <td>${IdleSince}</td>
                                                                                                    <td>${data[i].RestartSupported}</td>
                                                                                                    <td>${data[i].Hidden}</td>
                                                                                                    <td>${data[i].MaintenanceMode}</td>
                                                                                                    <td>${data[i].PowerState}</td>
                                                                                                    <td>${data[i].RegistrationState}</td>
                                                                                                </tr>`
                } else {
                    var row = `<tr class="session-row-disabled">
                                                                                                    <td>
                                                                                                        <div class="checkbox">
                                                                                                            <input type="checkbox" id="tr-session-checkbox${i}" disabled/>
                                                                                                            <label for="tr-session-checkbox${i}"></label>
                                                                                                        </div>
                                                                                                    </td>
                                                                                                    <td nowrap="nowrap">${MachineName}</td>
                                                                                                    <td>${data[i].SessionState}</td>
                                                                                                    <td>${StartTime}</td>
                                                                                                    <td>${SessionStateChangeTime}</td>
                                                                                                    <td>${data[i].ApplicationState}</td>
                                                                                                    <td>${ApplicationStateLastChangeTime}</td>
                                                                                                    <td nowrap="nowrap">${ApplicationsInUse}</td>
                                                                                                    <td>${data[i].IdleDuration}</td>
                                                                                                    <td>${IdleSince}</td>
                                                                                                    <td>${data[i].RestartSupported}</td>
                                                                                                    <td>${data[i].Hidden}</td>
                                                                                                    <td>${data[i].MaintenanceMode}</td>
                                                                                                    <td>${data[i].PowerState}</td>
                                                                                                    <td>${data[i].RegistrationState}</td>
                                                                                                </tr>`
                }
                var newrow = "";
                var lines = row.split("\n");
                for (var j = 0; j < lines.length; j++) {
                    if (j == 16) {
                        if (EnableGracefulMachineRestart || EnableForcedMachineRestart) {
                            newrow = newrow + lines[j];
                        };
                    };
                    if (j == 17) {
                        if (EnableHideStuckSessions || EnableUnhideSessions) {
                            newrow = newrow + lines[j];
                        };
                    };
                    if (j != 16 && j != 17) {
                        newrow = newrow + lines[j];
                    };
                };
                table.innerHTML += newrow;
            };
        };

        // This function will build the drop down list of sites
        function buildDropDownList(data) {
            $("#selectEnvironment").find('option').remove();
            $("#selectEnvironment").append('<option value="" selected disabled>Select the Citrix environment</option>');
            var datalength = data.length;
            var setDefault = false;
            for (var i = 0; i < data.length; i++) {
                // We need to store multiple values for each option so we do this in html data attributes
                var valuea = data[i].Name
                var valueb = data[i].DeliveryControllers
                var valuec = data[i].Port
                var option = data[i].FriendlyName
                if (data[i].Default.toUpperCase() == "TRUE" || datalength == 1) {
                    setDefault = true;
                    $("#selectEnvironment").append('<option value="' + (i + 1) + '" data-valuea="' + valuea + '" data-valueb="' + valueb + '" data-valuec="' + valuec + '" selected="selected">' + option + '</option>');
                } else {
                    $("#selectEnvironment").append('<option value="' + (i + 1) + '" data-valuea="' + valuea + '" data-valueb="' + valueb + '" data-valuec="' + valuec + '">' + option + '</option>');
                }
            }
            if (setDefault == true) {
                ProcessSelectEnvironment();
            }
        };

        // This function will build the table of processes
        function buildProcessesTable(data) {
            var table = document.getElementById('processesTableBody')
            table.innerHTML = ''

            for (var i = 0; i < data.length; i++) {
                var row = `<tr class=process-row>
                                                                                                    <td>
                                                                                                        <div class="checkbox">
                                                                                                            <input type="checkbox" id="tr-process-checkbox${i}">
                                                                                                            <label for="tr-process-checkbox${i}"></label>
                                                                                                        </div>
                                                                                                    </td>
                                                                                                    <td>${data[i].Name}</td>
                                                                                                    <td>${data[i].PID}</td>
                                                                                                    <td>${data[i].BytesPrivateMemorySize}</td>
                                                                                                    <td>${data[i].BytesWorkingSet}</td>
                                                                                                    <td>${data[i].BytesPeakWorkingSet}</td>
                                                                                                    <td>${data[i].BytesPagedMemorySize}</td>
                                                                                                    <td>${data[i].CpuUsagePercentage}</td>
                                                                                                    <td>${data[i].HandleCount}</td>
                                                                                                    <td>${data[i].Threads}</td>
                                                                                                    <td>${data[i].CommandLine}</td>
                                                                                                    <td>${data[i].Description}</td>
                                                                                                </tr>`
                table.innerHTML += row
            }
        };

        // This function will build the instructions based on the features that have been enabled
        function buildInstructions() {
            var instructions = document.getElementById('InstructionsSection');
            instructions.innerHTML = '';
            var i = 0;
            var newinstructions = `<p><b></b></p>`
            if (EnableLogoffSessions) 
            if (EnableDisconnectSessions) 
            if (EnableGetTerminateProcesses) 
            if (EnableGracefulMachineRestart && EnableLogoffSessions) 
            if (EnableGracefulMachineRestart && !EnableLogoffSessions) 
            if (EnableForcedMachineRestart) 
            if (EnableHideStuckSessions && EnableLogoffSessions && !BypassCriteriaChecksForHideSessions && !EnableUnhideSessions && (EnableGracefulMachineRestart || EnableForcedMachineRestart)) 
            if (EnableHideStuckSessions && !EnableLogoffSessions && !BypassCriteriaChecksForHideSessions && !EnableUnhideSessions && (EnableGracefulMachineRestart || EnableForcedMachineRestart)) 
            if (EnableHideStuckSessions && EnableLogoffSessions && BypassCriteriaChecksForHideSessions && !EnableUnhideSessions && (EnableGracefulMachineRestart || EnableForcedMachineRestart)) 
            if (EnableHideStuckSessions && !EnableLogoffSessions && BypassCriteriaChecksForHideSessions && !EnableUnhideSessions && (EnableGracefulMachineRestart || EnableForcedMachineRestart)) 
            if (EnableHideStuckSessions && EnableLogoffSessions && BypassCriteriaChecksForHideSessions && EnableUnhideSessions && (EnableGracefulMachineRestart || EnableForcedMachineRestart)) 
            if (EnableHideStuckSessions && !EnableLogoffSessions && BypassCriteriaChecksForHideSessions && EnableUnhideSessions && (EnableGracefulMachineRestart || EnableForcedMachineRestart)) 
            if (EnableHideStuckSessions && EnableLogoffSessions && !BypassCriteriaChecksForHideSessions && !EnableUnhideSessions && (!EnableGracefulMachineRestart && !EnableForcedMachineRestart)) 
            if (EnableHideStuckSessions && !EnableLogoffSessions && !BypassCriteriaChecksForHideSessions && !EnableUnhideSessions && (!EnableGracefulMachineRestart && !EnableForcedMachineRestart)) 
            if (EnableHideStuckSessions && EnableLogoffSessions && BypassCriteriaChecksForHideSessions && !EnableUnhideSessions && (!EnableGracefulMachineRestart && !EnableForcedMachineRestart)) 
            if (EnableHideStuckSessions && !EnableLogoffSessions && BypassCriteriaChecksForHideSessions && !EnableUnhideSessions && (!EnableGracefulMachineRestart && !EnableForcedMachineRestart)) 
            if (EnableHideStuckSessions && EnableLogoffSessions && BypassCriteriaChecksForHideSessions && EnableUnhideSessions && (!EnableGracefulMachineRestart && !EnableForcedMachineRestart)) 
            if (EnableHideStuckSessions && !EnableLogoffSessions && BypassCriteriaChecksForHideSessions && EnableUnhideSessions && (!EnableGracefulMachineRestart && !EnableForcedMachineRestart)) 
            newinstructions = newinstructions + `<p>${i = i + 1}) Contact the Service Desk if the above actions do not work, or you are unsure how to proceed. This tool may not address every scenario.</p>`
            if (EnableGetTerminateProcesses) {
                newinstructions = newinstructions + `
                             <p>

                            </p>`
            }
            newinstructions = newinstructions + `
                             <p>

                            </p>`
            instructions.innerHTML += newinstructions;
            //console.info(newinstructions);
        };

        // This function will get the logged on username in the format of DOMAIN\USERNAME
        function getLoggedOnUserName() {
            $.ajax({
                type: "GET",
                dataType: "json",
                url: "api/CtxSession/GetLoggedOnUserName",
                success: function (result) {
                    username = result
                    console.info("Username:", result);
                }
            });
        };

        // This function will get the diplayname for the logged on user from Active Directory using a callback function.
        function getDisplayNameCallback(result) {
            displayname = result;
            var greeting;
            var time = new Date().getHours();
            if (time < 12) {
                greeting = "Welcome";
            } else if (time < 18) {
                greeting = "Welcome";
            } else {
                greeting = "Welcome";
            }
            $("#welcome").text(greeting + " " + displayname)
        };
        function getDisplayName() {
            $.ajax({
                type: "GET",
                dataType: "json",
                url: 'api/CtxSession/GetDisplayName',
                success: function (data) {
                    console.info("Displayname:", data);
                    getDisplayNameCallback(data);
                },
                error: function (ex) {
                    console.info("ERROR:", ex);
                }
            });
        };

        // This function will get the list of sites, Delivery Controllers with their port numbers.
        function getCtxSiteList() {
            $.ajax({
                type: "GET",
                dataType: "json",
                url: "api/CtxSession/GetSiteList",
                success: function (result) {
                    buildDropDownList(result)
                    console.info("Sites:", result);
                }
            });
        };

        // This function will get the sessions for a user.
        // It passes the current user, Site Name, Delivery Controllers and port number in the URI.
        function getSessions(sitename, deliverycontrollers, port) {
            OpenStatusPopup()
            $("#statusmessage").append("<span>" + "Getting sessions...</br></span>");
            var querystring = "sitename=" + sitename + "&deliverycontrollers=" + deliverycontrollers + "&port=" + port;
            $.ajax({
                method: 'GET',
                url: 'api/CtxSession/GetSessions?' + querystring,
                success: function (response) {
                    sessionsArray = response
                    var message = "";
                    switch (sessionsArray.length) {
                        case 0:
                            message = "There were no sessions found";
                            break;
                        case 1:
                            message = "There was 1 session found";
                            break;
                        default:
                            message = "There were " + sessionsArray.length + " sessions found";
                    }
                    OpenStatusPopup()
                    $("#statusmessage").append("<span>" + message + "</br></span>");
                    buildSessionsTable(sessionsArray)
                    console.info("Sessions:", sessionsArray)
                }
            });
        };

        // This function will get a sessions for a user.
        // It passes the current user, Site Name, Delivery Controllers, port number, and the name of the Session Host in the URI.
        function findSession(sitename, deliverycontrollers, port, machinename) {
            OpenStatusPopup()
            $("#statusmessage").append("<span>" + "Finding session" + machinename + "...</br></span>");
            machinename = $("#findSession").val();
            var querystring = "machinename=" + machinename + "&sitename=" + sitename + "&deliverycontrollers=" + deliverycontrollers + "&port=" + port;
            $.ajax({
                type: "GET",
                dataType: "json",
                url: 'api/CtxSession/GetSession?' + querystring,
                success: function (result) {
                    var message = "";
                    if (result.length == 1) {
                        message = "There was 1 session found";
                    } else {
                        message = "There were no sessions found";
                    }
                    OpenStatusPopup()
                    $("#statusmessage").append("<span>" + message + "</br></span>");
                    buildSessionsTable(result)
                    console.info("Session:", result)
                }
            });
        };

        // This function will logoff the session(s) for a user.
        // It passes the Site Name, Delivery Controllers, port number, and an array of sessions to logoff in the body.
        function logoffSessions(sitename, deliverycontrollers, port, sessions) {
            OpenStatusPopup()
            $("#statusmessage").append("<span>" + "logging off </span>");
            var sessionsToLogoff = {
                "SiteName": sitename,
                "DeliveryControllers": deliverycontrollers,
                "Port": port,
                "MachineNames": sessions
            };
            $.ajax({
                type: "DELETE",
                dataType: "json",
                url: "api/CtxSession/LogoffSessions",
                data: sessionsToLogoff,
                success: function (result) {
                    console.info(result);
                    OpenStatusPopup()
                    $("#statusmessage").append("<span>" + "</span>");
                }
            });
        };

        // This function will disconnect the session(s) for a user.
        // It passes the Site Name, Delivery Controllers, port number, and an array of sessions to disconnect in the body.
        function disconnectSessions(sitename, deliverycontrollers, port, sessions) {
            OpenStatusPopup()
            $("#statusmessage").append("<span>" + "Disconnecting, </span>");
            var sessionsToDisconnect = {
                "SiteName": sitename,
                "DeliveryControllers": deliverycontrollers,
                "Port": port,
                "MachineNames": sessions
            };
            $.ajax({
                type: "PUT",
                dataType: "json",
                url: "api/CtxSession/DisconnectSessions",
                data: sessionsToDisconnect,
                success: function (result) {
                    console.info(result);
                    OpenStatusPopup()
                    $("#statusmessage").append("<span>" + "It can take a few seconds to complete. Click Refresh Sessions to verify.</br></span>");
                }
            });
        };

        // This function will restart the machines(s) for a user.
        // It passes the Site Name, Delivery Controllers, port number, an array of sessions to restart, and a boolean value caled Reset in the body.
        // If Reset is false, the machine(s) are gracefully restarted.
        // If Reset is true, the machine(s) are forecefully restarted.
        function restartMachines(sitename, deliverycontrollers, port, sessions, reset) {
            OpenStatusPopup()
            $("#statusmessage").append("<span>" + "Restarting machines...</br></span>");
            var machinesToRestart = {
                "SiteName": sitename,
                "DeliveryControllers": deliverycontrollers,
                "Port": port,
                "MachineNames": sessions,
                "Reset": reset
            };
            $.ajax({
                type: "DELETE",
                dataType: "json",
                url: "api/CtxSession/RestartMachines",
                data: machinesToRestart,
                success: function (result) {
                    console.info(result);
                    OpenStatusPopup()
                    if (result.toLowerCase().indexOf("does not meet the criteria to be restarted") >= 0) {
                        $("#statusmessage").append("<span>" + result + "</br></span>");
                    }
                    else {
                        if (reset == false) {
                            $("#statusmessage").append("<span>" + ": Machines are restarting. It can take a several seconds to complete. Refresh Sessions to verify.</br></span>");
                        } else {
                            $("#statusmessage").append("<span>" + ": Machines are forcefully restarting. It can take a several seconds to complete. Refresh Sessions to verify.</br></span>");
                            $("#statusmessage").append("<span>" + ": Note that this may leave some application windows displaying with the Citrix Receiver/Workspace app attempting to reconnect. This will clear after a couple of minutes.</br></span>");
                        }
                    }
                }
            });
        };

        // This function will hide or unhide the session(s) for a user.
        // It passes the Site Name, Delivery Controllers, port number, an array of sessions to hide, and a boolean value caled Hide in the body.
        // If Hide is true, the machine(s) are hidden.
        // If Hide is false, the machine(s) are unhidden.
        function hideSessions(sitename, deliverycontrollers, port, sessions, hide) {
            OpenStatusPopup()
            $("#statusmessage").append("<span>" + "and hiding sessions...</br></span>");
            var sessionsToHide = {
                "SiteName": sitename,
                "DeliveryControllers": deliverycontrollers,
                "Port": port,
                "MachineNames": sessions,
                "Hide": hide
            };
            $.ajax({
                type: "PUT",
                dataType: "json",
                url: "api/CtxSession/HideSessions",
                data: sessionsToHide,
                success: function (result) {
                    console.info(result);
                    OpenStatusPopup()
                    if (hide) {
                        if (result.toLowerCase().indexOf("does not meet the criteria to be hidden") >= 0) {
                            $("#statusmessage").append("<span>" + result + "</br></span>");
                        }
                        else {
                            $("#statusmessage").append("<span>" + "</span>");
                        }
                    } else {
                        $("#statusmessage").append("<span>" + "Sessions have been unhidden. Refresh Sessions to verify.</br></span>");
                    }
                }
            });
        };

        // This function will get the user processes from a remote host.
        // It passes the remote host and the current user in the URI.
        function getProcesses(remotehost) {
            OpenStatusPopup()
            $("#statusmessage").append("<span>" + ": Getting processes. This can take several seconds...</br></span>");
            var querystring = "remotehost=" + remotehost;
            $.ajax({
                type: "GET",
                dataType: "json",
                url: "api/UserProcess/Get?" + querystring,
                success: function (result) {
                    processesArray = result
                    buildProcessesTable(processesArray)
                    console.info("Processes:", result);
                    var message = "";
                    switch (processesArray.length) {
                        case 0:
                            message = "There were no processes found";
                            break;
                        case 1:
                            message = "There was 1 process found";
                            break;
                        default:
                            message = "There were " + processesArray.length + " processes found";
                    }
                    OpenStatusPopup()
                    $("#statusmessage").append("<span>" + message + "</br></span>");
                }
            });
        };

        // This function will terminate a processes from a remote host.
        // It passes the remote host and an array of process IDs (PIDs) in the body.
        // This allows for multiple processes to easily be passed in an array.
        function terminateProcesses(remotehost, pids) {
            OpenStatusPopup()
            $("#statusmessage").append("<span>" + ": Terminating processes...</br></span>");
            var processtoterminate = {
                "RemoteHost": remotehost,
                "PID": pids
            };
            $.ajax({
                type: "DELETE",
                dataType: "json",
                url: "api/UserProcess/Terminate",
                data: processtoterminate,
                success: function (result) {
                    console.info(result);
                    OpenStatusPopup()
                    $("#statusmessage").append("<span>" + ": Processes have been terminated. Select the Get Processes button to refresh the table.</br></span>");
                }
            });
        };

    </script>
	</center>
  </div>
  
  <div class="footer">
    <center>Made with <font color=ff0f0f><font size=4>&#x2665;</font></font> by <a href="https://github.com/virtualizebrief" target="_blank">Virtualize Brief</a></center>
  </div>

</div>
</body>
</html>